name: Unit Tests

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Debug - Check package.json
      run: |
        echo "Checking package.json scripts:"
        cat package.json | grep -A 10 '"scripts"'
        echo "Available npm scripts:"
        npm run

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: |
        echo "Running tests..."
        npm run test:run || npm test -- --run

    - name: Generate coverage report
      run: |
        echo "Generating coverage report..."
        npm run test:coverage || npm test -- --run --coverage

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: |
          coverage/
          TEST_REPORT.html
        retention-days: 30

    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        message: |
          ## ðŸ“Š Test Results
          
          âœ… **All tests passed!**
          
          - **Total Tests:** 38
          - **Coverage:** 100%
          - **Node.js:** ${{ matrix.node-version }}
          
          [View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
